<!DOCTYPE html>
<html lang="zh-TW">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ“ä½œè¨˜éŒ„ - æ±å³å¤§å­¸è³‡æ–™ç§‘å­¸ç³»å­¸ç”Ÿæœƒç®¡ç†ç³»çµ±</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <style>
    body {
      font-family: 'Microsoft JhengHei', Arial, sans-serif;
      background-color: #fff0f5;
      color: #4a3b47;
      opacity: 0;
      transition: opacity 0.3s ease-in-out;
    }

    body.loaded {
      opacity: 1;
    }

    .sidebar {
      position: fixed;
      top: 0;
      bottom: 0;
      left: 0;
      z-index: 100;
      padding: 48px 0 0;
      background-color: #ffb6c1;
    }

    .sidebar-sticky {
      position: relative;
      top: 0;
      height: calc(100vh - 48px);
      padding-top: .5rem;
      overflow-x: hidden;
      overflow-y: auto;
    }

    .nav-link {
      color: #4a3b47;
      font-weight: 500;
      padding: 0.5rem 1rem;
      transition: all 0.3s ease;
    }

    .nav-link:hover,
    .nav-link.active {
      background-color: #f08080;
      color: #fff;
    }

    .nav-link i {
      margin-right: 10px;
    }

    .main-content {
      margin-left: 240px;
      padding: 30px;
    }

    .navbar {
      position: fixed;
      top: 0;
      right: 0;
      left: 0;
      z-index: 1030;
      background-color: #ffc0cb;
      box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    }

    .navbar-brand {
      padding-left: 15px;
      font-weight: bold;
      color: #4a3b47 !important;
    }

    .filter-card {
      background-color: #ffe4e1;
      border: 2px solid #f8bbd0;
      margin-bottom: 20px;
    }

    .log-item {
      background-color: #ffe4e1;
      border: 1px solid #f8bbd0;
      border-radius: 8px;
      margin-bottom: 10px;
      padding: 15px;
      transition: all 0.3s ease;
    }

    .log-item:hover {
      background-color: #ffdde1;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .log-time {
      color: #666;
      font-size: 0.9rem;
    }

    .log-user {
      color: #e75480;
      font-weight: bold;
    }

    .log-action {
      color: #c2185b;
      font-weight: 500;
    }

    .log-description {
      color: #4a3b47;
      margin-top: 5px;
    }

    .action-badge {
      font-size: 0.8rem;
      padding: 4px 8px;
    }

    .action-create {
      background-color: #28a745;
      color: white;
    }

    .action-update {
      background-color: #ffc107;
      color: black;
    }

    .action-delete {
      background-color: #dc3545;
      color: white;
    }

    .action-login {
      background-color: #17a2b8;
      color: white;
    }

    .action-logout {
      background-color: #6c757d;
      color: white;
    }

    .action-view {
      background-color: #6f42c1;
      color: white;
    }

    .loading-spinner {
      display: none;
      text-align: center;
      padding: 20px;
    }

    @media (max-width: 767.98px) {
      .sidebar {
        width: 100%;
        height: auto;
        position: relative;
      }

      .main-content {
        margin-left: 0;
      }
    }
  </style>
</head>

<body>
  <!-- é ‚éƒ¨å°èˆªæ¬„ -->
  <nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container-fluid">
      <a class="navbar-brand" href="/dashboard">æ±å³å¤§å­¸è³‡æ–™ç§‘å­¸ç³»å­¸ç”Ÿæœƒ</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown">
              <span id="current-user">ä½¿ç”¨è€…</span>
            </a>
            <ul class="dropdown-menu dropdown-menu-end">
              <li><a class="dropdown-item" href="#" id="logout-btn">ç™»å‡º</a></li>
            </ul>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- å´é‚Šæ¬„ -->
  <div class="sidebar" style="width: 240px;">
    <div class="sidebar-sticky">
      <ul class="nav flex-column">
        <li class="nav-item">
          <a class="nav-link" href="/dashboard">
            <i class="bi bi-speedometer2"></i>é¦–é 
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/activity">
            <i class="bi bi-calendar-event"></i>æ´»å‹•éƒ¨
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/design">
            <i class="bi bi-brush"></i>ç¾å®£éƒ¨
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/pr">
            <i class="bi bi-people"></i>å…¬é—œéƒ¨
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/secretary">
            <i class="bi bi-file-text"></i>æ–‡æ›¸éƒ¨
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/finance">
            <i class="bi bi-cash-coin"></i>è²¡å‹™éƒ¨
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link active" href="/history">
            <i class="bi bi-clock-history"></i>æ­·å²è³‡æ–™
          </a>
        </li>
        <li class="nav-item admin-only" style="display: none;">
          <a class="nav-link" href="/admin">
            <i class="bi bi-gear"></i>ç³»çµ±ç®¡ç†
          </a>
        </li>
      </ul>
    </div>
  </div>

  <!-- ä¸»è¦å…§å®¹ -->
  <div class="main-content">
    <div class="container-fluid">
      <h1 class="mb-4"><i class="bi bi-clock-history me-2"></i>æ“ä½œè¨˜éŒ„</h1>

      <!-- ç¯©é¸å™¨ -->
      <div class="card filter-card">
        <div class="card-body">
          <h5 class="card-title"><i class="bi bi-funnel me-2"></i>ç¯©é¸æ¢ä»¶</h5>
          <div class="row g-3">
            <div class="col-md-3">
              <label for="userFilter" class="form-label">ä½¿ç”¨è€…</label>
              <select class="form-select" id="userFilter">
                <option value="">æ‰€æœ‰ä½¿ç”¨è€…</option>
              </select>
            </div>
            <div class="col-md-3">
              <label for="actionFilter" class="form-label">æ“ä½œé¡å‹</label>
              <select class="form-select" id="actionFilter">
                <option value="">æ‰€æœ‰æ“ä½œ</option>
                <option value="create">æ–°å¢</option>
                <option value="update">ä¿®æ”¹</option>
                <option value="delete">åˆªé™¤</option>
                <option value="login">ç™»å…¥</option>
                <option value="logout">ç™»å‡º</option>
                <option value="view">æŸ¥çœ‹</option>
              </select>
            </div>
            <div class="col-md-3">
              <label for="dateFrom" class="form-label">é–‹å§‹æ—¥æœŸ</label>
              <input type="date" class="form-control" id="dateFrom">
            </div>
            <div class="col-md-3">
              <label for="dateTo" class="form-label">çµæŸæ—¥æœŸ</label>
              <input type="date" class="form-control" id="dateTo">
            </div>
          </div>
          <div class="row mt-3">
            <div class="col-md-6">
              <label for="searchKeyword" class="form-label">é—œéµå­—æœç´¢</label>
              <input type="text" class="form-control" id="searchKeyword" placeholder="æœç´¢æ“ä½œæè¿°...">
            </div>
            <div class="col-md-6 d-flex align-items-end">
              <button type="button" class="btn btn-primary me-2" onclick="applyFilters()">
                <i class="bi bi-search me-1"></i>æœç´¢
              </button>
              <button type="button" class="btn btn-outline-secondary me-2" onclick="clearFilters()">
                <i class="bi bi-arrow-clockwise me-1"></i>é‡ç½®
              </button>
              <button type="button" class="btn btn-danger" id="deleteAllBtn" onclick="deleteAllLogs()" style="display: none;">
                <i class="bi bi-trash me-1"></i>ä¸€éµåˆªé™¤å…¨éƒ¨
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- æ“ä½œè¨˜éŒ„åˆ—è¡¨ -->
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0"><i class="bi bi-list-ul me-2"></i>æ“ä½œè¨˜éŒ„åˆ—è¡¨</h5>
          <div>
            <span class="badge bg-info" id="totalCount">ç¸½è¨ˆ: 0 ç­†</span>
          </div>
        </div>
        <div class="card-body">
          <div class="loading-spinner" id="loadingSpinner">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">è¼‰å…¥ä¸­...</span>
            </div>
            <p class="mt-2">è¼‰å…¥æ“ä½œè¨˜éŒ„ä¸­...</p>
          </div>
          
          <div id="logsList">
            <!-- æ“ä½œè¨˜éŒ„å°‡åœ¨é€™è£¡å‹•æ…‹è¼‰å…¥ -->
          </div>
          
          <div id="noLogs" class="text-center text-muted py-4" style="display: none;">
            <i class="bi bi-inbox display-4"></i>
            <p class="mt-2">æš«ç„¡æ“ä½œè¨˜éŒ„</p>
          </div>
          
          <!-- åˆ†é  -->
          <nav aria-label="æ“ä½œè¨˜éŒ„åˆ†é " id="pagination" style="display: none;">
            <ul class="pagination justify-content-center">
              <!-- åˆ†é æŒ‰éˆ•å°‡åœ¨é€™è£¡å‹•æ…‹ç”Ÿæˆ -->
            </ul>
          </nav>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let currentPage = 1;
    const pageSize = 20;
    let totalPages = 1;
    let currentUser = null;

    document.addEventListener('DOMContentLoaded', async function () {
      console.log('ğŸš€ é–‹å§‹åˆå§‹åŒ–æ“ä½œè¨˜éŒ„é é¢...');
      
      // ç«‹å³é¡¯ç¤ºé é¢å…§å®¹
      document.body.classList.add('loaded');
      
      try {
        // ç²å–ç”¨æˆ¶è³‡è¨Š
        await checkAuth();
        
        // è¼‰å…¥æ“ä½œè¨˜éŒ„
        await loadLogs();
        
        // è¼‰å…¥ä½¿ç”¨è€…åˆ—è¡¨ç”¨æ–¼ç¯©é¸
        await loadUsers();
        
        console.log('âœ… æ“ä½œè¨˜éŒ„é é¢åˆå§‹åŒ–å®Œæˆ');
        
      } catch (error) {
        console.error('åˆå§‹åŒ–éŒ¯èª¤:', error);
      }

      // ç™»å‡ºæŒ‰éˆ•è™•ç†
      const logoutBtn = document.getElementById('logout-btn');
      if (logoutBtn) {
        logoutBtn.addEventListener('click', async function (e) {
          e.preventDefault();
          if (confirm('ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ')) {
            try {
              await fetch('/auth/logout', {
                method: 'POST',
                credentials: 'include'
              });
            } catch (error) {
              console.error('ç™»å‡ºéŒ¯èª¤:', error);
            } finally {
              window.location.href = '/';
            }
          }
        });
      }
    });

    // æª¢æŸ¥èªè­‰ç‹€æ…‹
    async function checkAuth() {
      try {
        const response = await fetch('/auth/check', {
          method: 'GET',
          credentials: 'include'
        });
        
        if (response.status === 200) {
          const data = await response.json();
          
          if (data.authenticated && data.user) {
            currentUser = data.user;
            document.getElementById('current-user').textContent = data.user.username || 'ä½¿ç”¨è€…';
            
            // å¦‚æœæ˜¯ç®¡ç†å“¡ï¼Œé¡¯ç¤ºç®¡ç†å“¡é¸é …
            if (data.user.role === 'admin') {
              document.querySelectorAll('.admin-only').forEach(el => {
                el.style.display = 'block';
              });
              // é¡¯ç¤ºä¸€éµåˆªé™¤æŒ‰éˆ•
              const deleteAllBtn = document.getElementById('deleteAllBtn');
              if (deleteAllBtn) {
                deleteAllBtn.style.display = 'inline-block';
              }
            }
          } else {
            window.location.replace('/');
            return;
          }
        } else if (response.status === 401) {
          window.location.replace('/');
          return;
        }
      } catch (error) {
        console.error('èªè­‰æª¢æŸ¥å¤±æ•—:', error);
        window.location.replace('/');
      }
    }

    // è¼‰å…¥æ“ä½œè¨˜éŒ„
    async function loadLogs() {
      const loadingSpinner = document.getElementById('loadingSpinner');
      const logsList = document.getElementById('logsList');
      const noLogs = document.getElementById('noLogs');
      const totalCount = document.getElementById('totalCount');
      
      try {
        loadingSpinner.style.display = 'block';
        logsList.innerHTML = '';
        noLogs.style.display = 'none';
        
        // æ§‹å»ºæŸ¥è©¢åƒæ•¸
        const params = new URLSearchParams({
          page: currentPage,
          limit: pageSize
        });
        
        // æ·»åŠ ç¯©é¸æ¢ä»¶
        const userFilter = document.getElementById('userFilter')?.value;
        const actionFilter = document.getElementById('actionFilter')?.value;
        const dateFrom = document.getElementById('dateFrom')?.value;
        const dateTo = document.getElementById('dateTo')?.value;
        const searchKeyword = document.getElementById('searchKeyword')?.value;
        
        if (userFilter) params.append('user', userFilter);
        if (actionFilter) params.append('action', actionFilter);
        if (dateFrom) params.append('dateFrom', dateFrom);
        if (dateTo) params.append('dateTo', dateTo);
        if (searchKeyword) params.append('search', searchKeyword);
        
        const response = await fetch(`/api/operation-logs?${params}`, {
          credentials: 'include'
        });
        
        if (!response.ok) {
          throw new Error('è¼‰å…¥æ“ä½œè¨˜éŒ„å¤±æ•—');
        }
        
        const data = await response.json();
        
        if (data.logs && data.logs.length > 0) {
          logsList.innerHTML = data.logs.map(log => createLogItem(log)).join('');
          totalCount.textContent = `ç¸½è¨ˆ: ${data.total} ç­†`;
          
          // æ›´æ–°åˆ†é 
          totalPages = Math.ceil(data.total / pageSize);
          updatePagination();
        } else {
          noLogs.style.display = 'block';
          totalCount.textContent = 'ç¸½è¨ˆ: 0 ç­†';
          document.getElementById('pagination').style.display = 'none';
        }
        
      } catch (error) {
        console.error('è¼‰å…¥æ“ä½œè¨˜éŒ„éŒ¯èª¤:', error);
        logsList.innerHTML = '<div class="alert alert-danger">è¼‰å…¥æ“ä½œè¨˜éŒ„å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦</div>';
      } finally {
        loadingSpinner.style.display = 'none';
      }
    }

    // å‰µå»ºæ“ä½œè¨˜éŒ„é …ç›®
    function createLogItem(log) {
      const actionBadgeClass = getActionBadgeClass(log.action);
      const formattedTime = new Date(log.created_at).toLocaleString('zh-TW');
      
      // åªæœ‰ç®¡ç†å“¡å¯ä»¥çœ‹åˆ°åˆªé™¤æŒ‰éˆ•
      const deleteButton = currentUser && currentUser.role === 'admin' ? 
        `<button class="btn btn-sm btn-outline-danger ms-2" onclick="deleteLog('${log.id}')" title="åˆªé™¤æ­¤è¨˜éŒ„">
          <i class="bi bi-trash"></i>
        </button>` : '';
      
      return `
        <div class="log-item" data-log-id="${log.id}">
          <div class="d-flex justify-content-between align-items-start">
            <div class="flex-grow-1">
              <div class="d-flex align-items-center mb-2">
                <span class="log-user me-2">${escapeHtml(log.username)}</span>
                <span class="badge action-badge ${actionBadgeClass}">${getActionText(log.action)}</span>
                <span class="log-time ms-auto">${formattedTime}</span>
                ${deleteButton}
              </div>
              <div class="log-description">
                ${escapeHtml(log.description)}
              </div>
              ${log.details ? `<div class="text-muted small mt-1">è©³ç´°: ${escapeHtml(log.details)}</div>` : ''}
            </div>
          </div>
        </div>
      `;
    }

    // ç²å–æ“ä½œé¡å‹å°æ‡‰çš„æ¨£å¼é¡åˆ¥
    function getActionBadgeClass(action) {
      const classMap = {
        'create': 'action-create',
        'update': 'action-update',
        'delete': 'action-delete',
        'login': 'action-login',
        'logout': 'action-logout',
        'view': 'action-view'
      };
      return classMap[action] || 'bg-secondary';
    }

    // ç²å–æ“ä½œé¡å‹çš„ä¸­æ–‡æ–‡å­—
    function getActionText(action) {
      const textMap = {
        'create': 'æ–°å¢',
        'update': 'ä¿®æ”¹',
        'delete': 'åˆªé™¤',
        'login': 'ç™»å…¥',
        'logout': 'ç™»å‡º',
        'view': 'æŸ¥çœ‹'
      };
      return textMap[action] || action;
    }

    // è¼‰å…¥ä½¿ç”¨è€…åˆ—è¡¨
    async function loadUsers() {
      try {
        const response = await fetch('/api/users', {
          credentials: 'include'
        });
        
        if (response.ok) {
          const users = await response.json();
          const userFilter = document.getElementById('userFilter');
          
          users.forEach(user => {
            const option = document.createElement('option');
            option.value = user.username;
            option.textContent = user.username;
            userFilter.appendChild(option);
          });
        }
      } catch (error) {
        console.error('è¼‰å…¥ä½¿ç”¨è€…åˆ—è¡¨éŒ¯èª¤:', error);
      }
    }

    // æ‡‰ç”¨ç¯©é¸æ¢ä»¶
    function applyFilters() {
      currentPage = 1;
      loadLogs();
    }

    // æ¸…é™¤ç¯©é¸æ¢ä»¶
    function clearFilters() {
      document.getElementById('userFilter').value = '';
      document.getElementById('actionFilter').value = '';
      document.getElementById('dateFrom').value = '';
      document.getElementById('dateTo').value = '';
      document.getElementById('searchKeyword').value = '';
      currentPage = 1;
      loadLogs();
    }

    // æ›´æ–°åˆ†é 
    function updatePagination() {
      const pagination = document.getElementById('pagination');
      
      if (totalPages <= 1) {
        pagination.style.display = 'none';
        return;
      }
      
      pagination.style.display = 'block';
      const paginationList = pagination.querySelector('.pagination');
      paginationList.innerHTML = '';
      
      // ä¸Šä¸€é æŒ‰éˆ•
      const prevItem = document.createElement('li');
      prevItem.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
      prevItem.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage - 1})">ä¸Šä¸€é </a>`;
      paginationList.appendChild(prevItem);
      
      // é ç¢¼æŒ‰éˆ•
      const startPage = Math.max(1, currentPage - 2);
      const endPage = Math.min(totalPages, currentPage + 2);
      
      for (let i = startPage; i <= endPage; i++) {
        const pageItem = document.createElement('li');
        pageItem.className = `page-item ${i === currentPage ? 'active' : ''}`;
        pageItem.innerHTML = `<a class="page-link" href="#" onclick="changePage(${i})">${i}</a>`;
        paginationList.appendChild(pageItem);
      }
      
      // ä¸‹ä¸€é æŒ‰éˆ•
      const nextItem = document.createElement('li');
      nextItem.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
      nextItem.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage + 1})">ä¸‹ä¸€é </a>`;
      paginationList.appendChild(nextItem);
    }

    // åˆ‡æ›é é¢
    function changePage(page) {
      if (page >= 1 && page <= totalPages && page !== currentPage) {
        currentPage = page;
        loadLogs();
      }
    }

    // åˆªé™¤æ“ä½œè¨˜éŒ„
    async function deleteLog(logId) {
      if (!currentUser || currentUser.role !== 'admin') {
        alert('åªæœ‰ç®¡ç†å“¡å¯ä»¥åˆªé™¤æ“ä½œè¨˜éŒ„');
        return;
      }
      
      if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†æ“ä½œè¨˜éŒ„å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) {
        return;
      }
      
      try {
        const response = await fetch(`/api/operation-logs/${logId}`, {
          method: 'DELETE',
          credentials: 'include'
        });
        
        if (response.ok) {
          // å¾DOMä¸­ç§»é™¤è©²è¨˜éŒ„
          const logElement = document.querySelector(`[data-log-id="${logId}"]`);
          if (logElement) {
            logElement.remove();
          }
          
          // é‡æ–°è¼‰å…¥è¨˜éŒ„ä»¥æ›´æ–°ç¸½æ•¸å’Œåˆ†é 
          await loadLogs();
          
          alert('æ“ä½œè¨˜éŒ„å·²æˆåŠŸåˆªé™¤');
        } else {
          const errorData = await response.json();
          alert(`åˆªé™¤å¤±æ•—: ${errorData.message || 'æœªçŸ¥éŒ¯èª¤'}`);
        }
      } catch (error) {
        console.error('åˆªé™¤æ“ä½œè¨˜éŒ„éŒ¯èª¤:', error);
        alert('åˆªé™¤æ“ä½œè¨˜éŒ„æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦');
      }
    }

    // ä¸€éµåˆªé™¤æ‰€æœ‰æ“ä½œè¨˜éŒ„
    async function deleteAllLogs() {
      console.log('deleteAllLogs è¢«èª¿ç”¨ï¼ŒcurrentUser:', currentUser);
      
      if (!currentUser) {
        alert('ç”¨æˆ¶æœªç™»å…¥ï¼Œè«‹é‡æ–°ç™»å…¥');
        return;
      }
      
      if (currentUser.role !== 'admin') {
        alert('åªæœ‰ç®¡ç†å“¡å¯ä»¥åŸ·è¡Œæ­¤æ“ä½œ');
        return;
      }
      
      const confirmMessage = 'âš ï¸ è­¦å‘Šï¼šæ­¤æ“ä½œå°‡åˆªé™¤æ‰€æœ‰æ“ä½œè¨˜éŒ„ï¼Œä¸”ç„¡æ³•å¾©åŸï¼\n\nç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ';
      if (!confirm(confirmMessage)) {
        return;
      }
      
      try {
        const response = await fetch('/api/operation-logs/delete-all', {
          method: 'DELETE',
          credentials: 'include',
          headers: {
            'Content-Type': 'application/json'
          }
        });
        
        if (response.ok) {
          // é‡æ–°è¼‰å…¥è¨˜éŒ„
          await loadLogs();
          alert('æ‰€æœ‰æ“ä½œè¨˜éŒ„å·²æˆåŠŸåˆªé™¤');
        } else {
          const errorData = await response.json();
          alert(`åˆªé™¤å¤±æ•—: ${errorData.message || 'æœªçŸ¥éŒ¯èª¤'}`);
        }
      } catch (error) {
        console.error('ä¸€éµåˆªé™¤æ“ä½œè¨˜éŒ„éŒ¯èª¤:', error);
        alert('åˆªé™¤æ“ä½œè¨˜éŒ„æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦');
      }
    }

    // HTMLè½‰ç¾©å‡½æ•¸
    function escapeHtml(text) {
      if (!text) return '';
      const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
      };
      return text.replace(/[&<>"']/g, function(m) { return map[m]; });
    }
  </script>
</body>

</html>